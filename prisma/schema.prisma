// -----------------------------------------------------------------------------
// @purpose: Brandbite core database schema (roles, tickets, tokens, ledger)
// @status: active
// @lastUpdate: 2025-11-13
// -----------------------------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Enums -------------------------------------------------------------------

enum UserRole {
  SITE_OWNER
  SITE_ADMIN
  DESIGNER
  CUSTOMER
}

enum TicketStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum LedgerDirection {
  CREDIT // token ekleme
  DEBIT  // token düşme
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

// --- Core Models -------------------------------------------------------------

model UserAccount {
  id         String   @id @default(cuid())
  authUserId String   @unique // BetterAuth / auth provider ID
  email      String   @unique
  name       String?
  role       UserRole @default(CUSTOMER)

  companies       CompanyMember[]
  designerTickets Ticket[]        @relation("DesignerTickets")
  customerTickets Ticket[]        @relation("CustomerTickets")

  ledgerEntries TokenLedger[] @relation("UserLedger")
  withdrawals   Withdrawal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Company {
  id   String @id @default(cuid())
  name String
  slug String @unique

  planId String?
  plan   Plan?   @relation(fields: [planId], references: [id])

  projects Project[]
  members  CompanyMember[]
  tickets  Ticket[]

  tokenBalance Int           @default(0)
  tokenLedgers TokenLedger[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CompanyMember {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  userId String
  user   UserAccount @relation(fields: [userId], references: [id])

  // company içi rol (ör: COMPANY_ADMIN, MEMBER vs. ileride enum’a çevirebiliriz)
  roleInCompany String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, userId])
}

model Project {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  name String
  code String? @unique

  tickets Ticket[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- Plan & Job Types --------------------------------------------------------

model Plan {
  id            String  @id @default(cuid())
  name          String  @unique // Basic / Pro / Full
  monthlyTokens Int     // 100 / 200 / 400 gibi
  priceCents    Int?    // opsiyonel: fiyat bilgisi
  isActive      Boolean @default(true)

  companies Company[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model JobType {
  id                   String  @id @default(cuid())
  name                 String  @unique
  description          String?
  tokenCost            Int     // müşteriden düşülecek token
  designerPayoutTokens Int     // designer’a eklenecek token
  isActive             Boolean @default(true)

  tickets Ticket[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- Tickets -----------------------------------------------------------------

model Ticket {
  id String @id @default(cuid())

  title       String
  description String?

  status   TicketStatus   @default(TODO)
  priority TicketPriority @default(MEDIUM)
  dueDate  DateTime?

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  // Ticket’i açan kullanıcı (customer)
  createdById String
  createdBy   UserAccount @relation("CustomerTickets", fields: [createdById], references: [id])

  // Atanan designer
  designerId String?
  designer   UserAccount? @relation("DesignerTickets", fields: [designerId], references: [id])

  jobTypeId String?
  jobType   JobType? @relation(fields: [jobTypeId], references: [id])

  // Şirket içi ticket numarası (opsiyonel – ileride doldurulabilir)
  companyTicketNumber Int?

  ledgerEntries TokenLedger[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- Tokens & Withdrawals ----------------------------------------------------

model TokenLedger {
  id String @id @default(cuid())

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  ticketId String?
  ticket   Ticket? @relation(fields: [ticketId], references: [id])

  userId String?
  user   UserAccount? @relation("UserLedger", fields: [userId], references: [id])

  direction LedgerDirection
  amount    Int        // + / - token miktarı
  reason    String?    // kısa kod: PLAN_PURCHASE, JOB_PAYMENT gibi

  // Açıklama alanları
  notes        String? // insan okunur açıklama
  metadata     Json?   // structured JSON: { "provider": "stripe", "chargeId": "..." }

  // Bakiye snapshot'ları (opsiyonel ama çok faydalı)
  balanceBefore Int?
  balanceAfter  Int?

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([userId])
  @@index([ticketId])
  @@index([createdAt])
}

model Withdrawal {
  id String @id @default(cuid())

  designerId String
  designer   UserAccount @relation(fields: [designerId], references: [id])

  amountTokens Int
  status       WithdrawalStatus @default(PENDING)

  notes    String?
  metadata Json?

  createdAt  DateTime  @default(now()) // request zamanı
  approvedAt DateTime?                // admin onay zamanı
  paidAt     DateTime?                // gerçek ödeme zamanı

  @@index([designerId])
  @@index([status])
}
