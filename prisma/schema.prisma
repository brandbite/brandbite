// -----------------------------------------------------------------------------
// @file: prisma/schema.prisma
// @purpose: Brandbite core database schema (roles, tickets, tokens, ledger)
// @version: v2.0.0
// @status: active
// @lastUpdate: 2026-02-20
// -----------------------------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------------------------------
// Enums
// -----------------------------------------------------------------------------

enum UserRole {
  SITE_OWNER
  SITE_ADMIN
  DESIGNER  // DB value stays "DESIGNER"; display label = "Creative"
  CUSTOMER
}

enum TicketStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum LedgerDirection {
  CREDIT
  DEBIT
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

enum CompanyRole {
  OWNER // company owner
  PM // company-wide project management
  BILLING // accountant / finance
  MEMBER // regular member (default)
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

/// Project-level role
enum ProjectRole {
  OWNER // project owner (usually company owner / lead)
  PM // project manager
  CONTRIBUTOR // aktif calisan
  VIEWER // read-only
}

enum AutoAssignMode {
  INHERIT
  ON
  OFF
}

enum BillingStatus {
  ACTIVE
  PAST_DUE
  CANCELED
}

// --- Notifications ---

enum NotificationType {
  REVISION_SUBMITTED    // Creative submitted a new revision
  FEEDBACK_SUBMITTED    // Customer submitted revision feedback (pins)
  TICKET_COMPLETED      // Ticket marked as DONE
  TICKET_ASSIGNED       // Ticket assigned to creative
  TICKET_STATUS_CHANGED // Any status transition
  PIN_RESOLVED          // Creative resolved a pin
}

// --- Assets & Annotations ---

enum AssetKind {
  BRIEF_INPUT
  OUTPUT_IMAGE
}

enum PinStatus {
  OPEN
  RESOLVED
}

enum TagColor {
  GRAY
  BLUE
  GREEN
  ORANGE
  RED
  PURPLE
  PINK
  YELLOW
}

// -----------------------------------------------------------------------------
// Core User & Auth
// -----------------------------------------------------------------------------

model UserAccount {
  id         String   @id @default(cuid())
  authUserId String   @unique
  email      String   @unique
  name       String?
  role       UserRole

  /// Admin-controlled flag: whether this creative can send revision notes to clients
  creativeRevisionNotesEnabled Boolean @default(false) @map("designerRevisionNotesEnabled")

  /// Whether this creative has paused accepting new assignments
  isPaused       Boolean   @default(false)
  /// When the creative activated pause mode
  pausedAt       DateTime?
  /// When the pause expires (null = manual/indefinite pause)
  pauseExpiresAt DateTime?
  /// Pause type: "1_HOUR", "7_DAYS", "MANUAL"
  pauseType      String?

  // Relations
  companies       CompanyMember[]
  creativeTickets  Ticket[]        @relation("CreativeTickets")
  customerTickets  Ticket[]        @relation("CustomerTickets")
  completedTickets Ticket[]        @relation("TicketCompletedBy")

  projectMemberships ProjectMember[]

  companyInvitesSent CompanyInvite[]

  ledgerEntries  TokenLedger[]   @relation("UserLedger")
  withdrawals    Withdrawal[]
  ticketComments TicketComment[]

  assignmentLogs TicketAssignmentLog[]

  submittedRevisions TicketRevision[] @relation("TicketRevisionSubmittedBy")
  feedbackRevisions  TicketRevision[] @relation("TicketRevisionFeedbackBy")

  // Assets & annotations
  createdAssets       Asset[]
  createdAssetPins    AssetPin[]        @relation("AssetPinCreatedBy")
  resolvedAssetPins   AssetPin[]        @relation("AssetPinResolvedBy")
  assetPinComments    AssetPinComment[]

  // Notifications
  notifications        Notification[]           @relation("UserNotifications")
  actedNotifications   Notification[]           @relation("NotificationActor")
  notificationPrefs    NotificationPreference[]

  // Creative skills (job type capabilities)
  creativeSkills CreativeSkill[] @relation("CreativeSkills")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -----------------------------------------------------------------------------
// Company & Plans
// -----------------------------------------------------------------------------

model Company {
  id   String @id @default(cuid())
  name String

  slug String @unique

  website String? // Company website URL (optional)

  planId String?
  plan   Plan?   @relation(fields: [planId], references: [id])

  /// Company default auto-assign behaviour:
  /// - true: if project is "INHERIT", auto-assign is considered enabled.
  /// - false: if project is "INHERIT", auto-assign is considered disabled.
  autoAssignDefaultEnabled Boolean @default(false)

  members CompanyMember[]

  projects Project[]

  tickets Ticket[]

  invites CompanyInvite[]

  ledgerEntries TokenLedger[]

  // Tags (company-scoped labels for tickets)
  tags TicketTag[]

  // Output presets (optional company overrides)
  outputSizePresets OutputSizePreset[]

  // Stripe billing mapping
  stripeCustomerId     String?        @unique
  stripeSubscriptionId String?        @unique
  billingStatus        BillingStatus?

  tokenBalance Int @default(0)

  /// Null = onboarding not yet completed (wizard should be shown).
  /// Set to now() once the customer finishes the onboarding wizard.
  onboardingCompletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CompanyMember {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  userId String
  user   UserAccount @relation(fields: [userId], references: [id])

  /// Company-level role:
  /// - OWNER  : company owner (plan, billing, members)
  /// - PM     : company-wide project / ticket management
  /// - BILLING: accounting / finance
  /// - MEMBER : regular member (default)
  roleInCompany CompanyRole @default(MEMBER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, userId])
}

model CompanyInvite {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  email String

  invitedByUserId String?
  invitedByUser   UserAccount? @relation(fields: [invitedByUserId], references: [id])

  /// The role the invitee will receive upon accepting (defaults to MEMBER)
  roleInCompany CompanyRole @default(MEMBER)

  token  String       @unique
  status InviteStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([email])
}

model Plan {
  id   String @id @default(cuid())
  name String

  description String?

  stripeProductId String? @unique
  stripePriceId   String? @unique

  monthlyTokens Int
  priceCents    Int

  isActive Boolean @default(true)

  // Plan-level max concurrent IN_PROGRESS ticket count
  maxConcurrentInProgressTickets Int @default(1)

  companies Company[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -----------------------------------------------------------------------------
// Projects & Membership
// -----------------------------------------------------------------------------

model Project {
  id        String  @id
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  name String
  code String? @unique

  autoAssignMode AutoAssignMode @default(INHERIT)

  members ProjectMember[]
  tickets Ticket[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model ProjectMember {
  id String @id @default(cuid())

  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  userId String
  user   UserAccount @relation(fields: [userId], references: [id])

  role ProjectRole @default(CONTRIBUTOR)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, userId])
}

// -----------------------------------------------------------------------------
// Job Type Categories
// -----------------------------------------------------------------------------

model JobTypeCategory {
  id        String  @id @default(cuid())
  name      String  @unique
  slug      String  @unique
  icon      String? // emoji or icon identifier
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  jobTypes JobType[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -----------------------------------------------------------------------------
// Job Types
// -----------------------------------------------------------------------------

model JobType {
  id String @id @default(cuid())

  name                 String
  category             String?           // legacy free-text category (kept for migration)
  categoryId           String?
  categoryRef          JobTypeCategory?  @relation(fields: [categoryId], references: [id])
  description          String?
  tokenCost            Int
  creativePayoutTokens Int               @map("designerPayoutTokens")
  estimatedHours       Int?              // from service catalog (for reference)

  // Quantity support — some jobs are per-unit (e.g. banner sizes, pages)
  hasQuantity      Boolean @default(false) // show quantity stepper in form
  quantityLabel    String?                 // e.g. "Number of sizes", "Number of pages"
  defaultQuantity  Int     @default(1)     // pre-filled quantity for this job type

  isActive Boolean @default(true)

  tickets Ticket[]

  // Output size presets (global presets live here; company overrides also relate here)
  outputSizePresets OutputSizePreset[]

  creativeSkills CreativeSkill[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
}

// -----------------------------------------------------------------------------
// Creative Skills (many-to-many: UserAccount <-> JobType)
// -----------------------------------------------------------------------------

model CreativeSkill {
  id String @id @default(cuid())

  creativeId String      @map("designerId")
  creative   UserAccount @relation("CreativeSkills", fields: [creativeId], references: [id])

  jobTypeId String
  jobType   JobType @relation(fields: [jobTypeId], references: [id])

  createdAt DateTime @default(now())

  @@unique([creativeId, jobTypeId])
  @@index([creativeId])
  @@index([jobTypeId])
  @@map("DesignerSkill")
}

// -----------------------------------------------------------------------------
// Output size presets & ticket output specs (quantity/sizes)
// -----------------------------------------------------------------------------

model OutputSizePreset {
  id String @id @default(cuid())

  // Optional company override; null means "global preset"
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  jobTypeId String
  jobType   JobType @relation(fields: [jobTypeId], references: [id])

  /// Stable identifier for code usage (e.g. "IG_POST_1080")
  key   String
  /// UI label (English)
  label String

  width Int
  height Int
  unit String @default("px")

  sortOrder Int @default(0)
  isActive  Boolean @default(true)

  ticketSpecs TicketOutputSpec[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, jobTypeId, key])
  @@index([jobTypeId, isActive, sortOrder])
}

model TicketOutputSpec {
  id String @id @default(cuid())

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id])

  presetId String
  preset   OutputSizePreset @relation(fields: [presetId], references: [id])

  quantity Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([ticketId, presetId])
  @@index([ticketId])
}

// -----------------------------------------------------------------------------
// Tickets & Comments
// -----------------------------------------------------------------------------

model Ticket {
  id String @id @default(cuid())

  title       String
  description String?

  status   TicketStatus   @default(TODO)
  priority TicketPriority @default(MEDIUM)
  dueDate  DateTime?

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  // User who created the ticket (customer)
  createdById String
  createdBy   UserAccount @relation("CustomerTickets", fields: [createdById], references: [id])

  // Assigned creative
  creativeId String?              @map("designerId")
  creative   UserAccount?         @relation("CreativeTickets", fields: [creativeId], references: [id])

  jobTypeId String?
  jobType   JobType? @relation(fields: [jobTypeId], references: [id])

  // Quantity multiplier (default 1). Effective cost = jobType.tokenCost * quantity.
  quantity Int @default(1)

  // Admin overrides — when set, these replace the calculated (jobType cost * quantity).
  tokenCostOverride      Int?
  creativePayoutOverride Int?     @map("designerPayoutOverride")

  // Completion tracking (who approved the final revision)
  completedAt   DateTime?
  completedById String?
  completedBy   UserAccount? @relation("TicketCompletedBy", fields: [completedById], references: [id])

  // Company-scoped ticket number
  companyTicketNumber Int?
  revisionCount       Int              @default(0)
  revisions           TicketRevision[]

  // Output specs (quantity/sizes)
  outputSpecs TicketOutputSpec[]

  // Assets (brief inputs + revision outputs)
  assets Asset[]

  ledgerEntries TokenLedger[]
  comments      TicketComment[]

  assignmentLogs TicketAssignmentLog[]
  notifications  Notification[]

  tagAssignments TicketTagAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([creativeId, status, updatedAt])
}

// -----------------------------------------------------------------------------
// Tags (company-scoped labels for tickets)
// -----------------------------------------------------------------------------

model TicketTag {
  id    String   @id @default(cuid())
  name  String
  color TagColor @default(GRAY)

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  assignments TicketTagAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, name])
  @@index([companyId])
}

model TicketTagAssignment {
  id String @id @default(cuid())

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id])

  tagId String
  tag   TicketTag @relation(fields: [tagId], references: [id])

  createdAt DateTime @default(now())

  @@unique([ticketId, tagId])
  @@index([ticketId])
  @@index([tagId])
}

model TicketComment {
  id String @id @default(cuid())

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id])

  authorId String
  author   UserAccount @relation(fields: [authorId], references: [id])

  body String

  createdAt DateTime @default(now())

  @@index([ticketId])
  @@index([authorId])
}

model TicketRevision {
  id String @id @default(cuid())

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id])

  /// Revision number for this ticket (v1, v2, v3, ...)
  version Int

  submittedByCreativeId String?          @map("submittedByDesignerId")
  submittedByCreative   UserAccount?     @relation("TicketRevisionSubmittedBy", fields: [submittedByCreativeId], references: [id])

  submittedAt DateTime @default(now())
  creativeMessage String?                @map("designerMessage")

  feedbackByCustomerId String?
  feedbackByCustomer   UserAccount? @relation("TicketRevisionFeedbackBy", fields: [feedbackByCustomerId], references: [id])

  feedbackAt      DateTime?
  feedbackMessage String?

  // Assets that belong to this revision (OUTPUT_IMAGE usually)
  assets Asset[]

  createdAt DateTime @default(now())

  @@unique([ticketId, version])
  @@index([ticketId, version])
  @@index([submittedByCreativeId, submittedAt])
  @@index([feedbackByCustomerId, feedbackAt])
}

// -----------------------------------------------------------------------------
// Assets & Pins (annotations)
// -----------------------------------------------------------------------------

model Asset {
  id String @id @default(cuid())

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id])

  /// OUTPUT_IMAGE assets typically belong to a revision; BRIEF_INPUT can be null
  revisionId String?
  revision   TicketRevision? @relation(fields: [revisionId], references: [id])

  kind AssetKind

  /// Storage metadata (S3 key / UploadThing key / blob id)
  storageKey String
  url        String?
  mimeType   String
  bytes      Int

  width        Int?
  height       Int?
  originalName String?

  createdById String
  createdBy   UserAccount @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  deletedAt DateTime?

  pins AssetPin[]

  @@index([ticketId, kind, createdAt])
  @@index([revisionId])
  @@index([createdById, createdAt])
}

model AssetPin {
  id String @id @default(cuid())

  assetId String
  asset   Asset @relation(fields: [assetId], references: [id])

  createdById String
  createdBy   UserAccount @relation("AssetPinCreatedBy", fields: [createdById], references: [id])

  /// Normalized coordinates (0..1)
  x Float
  y Float

  /// UI order/number (1..N) per asset
  order Int
  label String?
  status PinStatus @default(OPEN)

  resolvedAt   DateTime?
  resolvedById String?
  resolvedBy   UserAccount? @relation("AssetPinResolvedBy", fields: [resolvedById], references: [id])

  comments AssetPinComment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([assetId, order])
  @@index([assetId, status])
  @@index([createdById, createdAt])
}

model AssetPinComment {
  id String @id @default(cuid())

  pinId String
  pin   AssetPin @relation(fields: [pinId], references: [id])

  authorId String
  author   UserAccount @relation(fields: [authorId], references: [id])

  message String

  createdAt DateTime @default(now())

  @@index([pinId, createdAt])
  @@index([authorId, createdAt])
}

// -----------------------------------------------------------------------------
// Tokens & Ledger
// -----------------------------------------------------------------------------

model TokenLedger {
  id String @id @default(cuid())

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  ticketId String?
  ticket   Ticket? @relation(fields: [ticketId], references: [id])

  userId String?
  user   UserAccount? @relation("UserLedger", fields: [userId], references: [id])

  direction LedgerDirection
  amount    Int
  reason    String?
  notes     String?
  metadata  Json?

  balanceBefore Int?
  balanceAfter  Int?

  createdAt DateTime @default(now())

  @@index([companyId, createdAt])
  @@index([userId, createdAt])
  @@index([ticketId, createdAt])
}

// -----------------------------------------------------------------------------
// Withdrawals
// -----------------------------------------------------------------------------

model Withdrawal {
  id String @id @default(cuid())

  creativeId String       @map("designerId")
  creative   UserAccount  @relation(fields: [creativeId], references: [id])

  amountTokens Int
  status       WithdrawalStatus @default(PENDING)

  notes    String?
  metadata Json?

  createdAt  DateTime  @default(now())
  approvedAt DateTime?
  paidAt     DateTime?

  @@index([creativeId, createdAt])
  @@index([status, createdAt])
}

// -----------------------------------------------------------------------------
// Notifications
// -----------------------------------------------------------------------------

model Notification {
  id String @id @default(cuid())

  userId String
  user   UserAccount @relation("UserNotifications", fields: [userId], references: [id])

  type NotificationType

  title   String
  message String

  ticketId String?
  ticket   Ticket? @relation(fields: [ticketId], references: [id])

  /// The user who triggered this notification (creative or customer)
  actorId String?
  actor   UserAccount? @relation("NotificationActor", fields: [actorId], references: [id])

  read   Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())

  @@index([userId, read, createdAt])
  @@index([userId, createdAt])
}

model NotificationPreference {
  id String @id @default(cuid())

  userId String
  user   UserAccount @relation(fields: [userId], references: [id])

  type         NotificationType
  enabled      Boolean          @default(true)
  emailEnabled Boolean          @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, type])
}

// -----------------------------------------------------------------------------
// App Settings (key-value store for admin-configurable values)
// -----------------------------------------------------------------------------

model AppSetting {
  key   String @id
  value String

  updatedAt DateTime @updatedAt
}

// -----------------------------------------------------------------------------
// Payout Rules (admin-configurable creative payout milestones)
// -----------------------------------------------------------------------------

model PayoutRule {
  id                  String   @id @default(cuid())
  name                String
  description         String?
  minCompletedTickets Int
  timeWindowDays      Int
  payoutPercent       Int
  priority            Int      @default(0)
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([isActive, payoutPercent])
}

// -----------------------------------------------------------------------------
// Ticket Assignment Logs
// -----------------------------------------------------------------------------

model TicketAssignmentLog {
  id String @id @default(cuid())

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id])

  // Which creative was assigned to the ticket?
  creativeId String?          @map("designerId")
  creative   UserAccount?     @relation(fields: [creativeId], references: [id])

  /// reason examples:
  /// - AUTO_ASSIGN
  /// - MANUAL
  /// - FALLBACK
  /// - REBALANCE
  /// - SYSTEM_MIGRATION
  reason   String
  notes    String?
  metadata Json?

  createdAt DateTime @default(now())

  @@index([ticketId, createdAt])
  @@index([creativeId, createdAt])
  @@index([reason, createdAt])
}
