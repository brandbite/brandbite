// -----------------------------------------------------------------------------
// @file: prisma/schema.prisma
// @purpose: Brandbite core database schema (roles, tickets, tokens, ledger)
// @version: v1.7.0
// @status: active
// @lastUpdate: 2025-12-25
// -----------------------------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------------------------------
// Enums
// -----------------------------------------------------------------------------

enum UserRole {
  SITE_OWNER
  SITE_ADMIN
  DESIGNER
  CUSTOMER
}

enum TicketStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum LedgerDirection {
  CREDIT
  DEBIT
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

enum CompanyRole {
  OWNER // company owner
  PM // company-wide project management
  BILLING // accountant / finance
  MEMBER // regular member (default)
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

/// Project-level role
enum ProjectRole {
  OWNER // project owner (usually company owner / lead)
  PM // project manager
  CONTRIBUTOR // aktif çalışan
  VIEWER // read-only
}

enum AutoAssignMode {
  INHERIT
  ON
  OFF
}

enum BillingStatus {
  ACTIVE
  PAST_DUE
  CANCELED
}

// -----------------------------------------------------------------------------
// Core User & Auth
// -----------------------------------------------------------------------------

model UserAccount {
  id         String   @id @default(cuid())
  authUserId String   @unique
  email      String   @unique
  name       String?
  role       UserRole

  /// Admin-controlled flag: whether this designer can send revision notes to clients
  designerRevisionNotesEnabled Boolean @default(false)

  // Relations
  companies       CompanyMember[]
  designerTickets Ticket[]        @relation("DesignerTickets")
  customerTickets Ticket[]        @relation("CustomerTickets")

  projectMemberships ProjectMember[]

  companyInvitesSent CompanyInvite[]

  ledgerEntries  TokenLedger[]   @relation("UserLedger")
  withdrawals    Withdrawal[]
  ticketComments TicketComment[]

  assignmentLogs TicketAssignmentLog[]

  submittedRevisions TicketRevision[] @relation("TicketRevisionSubmittedBy")
  feedbackRevisions  TicketRevision[] @relation("TicketRevisionFeedbackBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -----------------------------------------------------------------------------
// Company & Plans
// -----------------------------------------------------------------------------

model Company {
  id   String @id @default(cuid())
  name String

  slug String @unique

  planId String?
  plan   Plan?   @relation(fields: [planId], references: [id])

  /// Şirket için default auto-assign davranışı:
  /// - true: eğer proje "INHERIT" ise auto-assign açık kabul edilir.
  /// - false: eğer proje "INHERIT" ise auto-assign kapalı kabul edilir.
  autoAssignDefaultEnabled Boolean @default(false)

  members CompanyMember[]

  projects Project[]

  tickets Ticket[]

  invites CompanyInvite[]

  ledgerEntries TokenLedger[]

  // Stripe billing mapping (ileride kullanılacak)
  stripeCustomerId     String?        @unique
  stripeSubscriptionId String?        @unique
  billingStatus        BillingStatus?

  tokenBalance Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CompanyMember {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  userId String
  user   UserAccount @relation(fields: [userId], references: [id])

  /// company içi rol:
  /// - OWNER  : şirket sahibi (plan, billing, üyeler)
  /// - PM     : şirket genelinde proje / ticket yönetimi
  /// - BILLING: muhasebe / fatura
  /// - MEMBER : normal üye (default)
  roleInCompany CompanyRole @default(MEMBER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, userId])
}

model CompanyInvite {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  email String

  invitedByUserId String?
  invitedByUser   UserAccount? @relation(fields: [invitedByUserId], references: [id])

  token  String       @unique
  status InviteStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([email])
}

model Plan {
  id   String @id @default(cuid())
  name String

  description String?

  stripeProductId String? @unique
  stripePriceId   String? @unique

  monthlyTokens Int
  priceCents    Int // seed.mjs ile uyumlu

  isActive Boolean @default(true)

  // Plan bazlı maksimum eşzamanlı IN_PROGRESS ticket sayısı
  maxConcurrentInProgressTickets Int @default(1)

  companies Company[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -----------------------------------------------------------------------------
// Projects & Membership
// -----------------------------------------------------------------------------

model Project {
  id        String  @id
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  name String
  code String? @unique

  autoAssignMode AutoAssignMode @default(INHERIT)

  members ProjectMember[]
  tickets Ticket[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model ProjectMember {
  id String @id @default(cuid())

  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  userId String
  user   UserAccount @relation(fields: [userId], references: [id])

  role ProjectRole @default(CONTRIBUTOR)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, userId])
}

// -----------------------------------------------------------------------------
// Job Types
// -----------------------------------------------------------------------------

model JobType {
  id String @id @default(cuid())

  name                 String
  description          String?
  tokenCost            Int
  designerPayoutTokens Int // seed.mjs ile uyumlu

  isActive Boolean @default(true)

  tickets Ticket[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -----------------------------------------------------------------------------
// Tickets & Comments
// -----------------------------------------------------------------------------

model Ticket {
  id String @id @default(cuid())

  title       String
  description String?

  status   TicketStatus   @default(TODO)
  priority TicketPriority @default(MEDIUM)
  dueDate  DateTime?

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  // Ticket’i açan kullanıcı (customer)
  createdById String
  createdBy   UserAccount @relation("CustomerTickets", fields: [createdById], references: [id])

  // Atanan designer
  designerId String?
  designer   UserAccount? @relation("DesignerTickets", fields: [designerId], references: [id])

  jobTypeId String?
  jobType   JobType? @relation(fields: [jobTypeId], references: [id])

  // Şirket içi ticket numarası
  companyTicketNumber Int?
  revisionCount       Int              @default(0)
  revisions           TicketRevision[]

  ledgerEntries TokenLedger[]
  comments      TicketComment[]

  assignmentLogs TicketAssignmentLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TicketComment {
  id String @id @default(cuid())

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id])

  authorId String
  author   UserAccount @relation(fields: [authorId], references: [id])

  body String

  createdAt DateTime @default(now())

  @@index([ticketId])
  @@index([authorId])
}

model TicketRevision {
  id String @id @default(cuid())

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id])

  /// Revision number for this ticket (v1, v2, v3, ...)
  version Int

  submittedByDesignerId String?
  submittedByDesigner   UserAccount? @relation("TicketRevisionSubmittedBy", fields: [submittedByDesignerId], references: [id])

  submittedAt DateTime @default(now())
  designerMessage String?

  feedbackByCustomerId String?
  feedbackByCustomer   UserAccount? @relation("TicketRevisionFeedbackBy", fields: [feedbackByCustomerId], references: [id])

  feedbackAt      DateTime?
  feedbackMessage String?

  createdAt DateTime @default(now())

  @@unique([ticketId, version])
  @@index([ticketId, version])
  @@index([submittedByDesignerId, submittedAt])
  @@index([feedbackByCustomerId, feedbackAt])
}

// -----------------------------------------------------------------------------
// Tokens & Ledger
// -----------------------------------------------------------------------------

model TokenLedger {
  id String @id @default(cuid())

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  ticketId String?
  ticket   Ticket? @relation(fields: [ticketId], references: [id])

  userId String?
  user   UserAccount? @relation("UserLedger", fields: [userId], references: [id])

  direction LedgerDirection
  amount    Int
  reason    String?
  notes     String?
  metadata  Json?

  balanceBefore Int?
  balanceAfter  Int?

  createdAt DateTime @default(now())

  @@index([companyId, createdAt])
  @@index([userId, createdAt])
  @@index([ticketId, createdAt])
}

// -----------------------------------------------------------------------------
// Withdrawals
// -----------------------------------------------------------------------------

model Withdrawal {
  id String @id @default(cuid())

  designerId String
  designer   UserAccount @relation(fields: [designerId], references: [id])

  amountTokens Int
  status       WithdrawalStatus @default(PENDING)

  notes    String?
  metadata Json?

  createdAt  DateTime  @default(now())
  approvedAt DateTime?
  paidAt     DateTime?

  @@index([designerId, createdAt])
  @@index([status, createdAt])
}

// -----------------------------------------------------------------------------
// Ticket Assignment Logs
// -----------------------------------------------------------------------------

model TicketAssignmentLog {
  id String @id @default(cuid())

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id])

  // Ticket hangi designera atanmış?
  designerId String?
  designer   UserAccount? @relation(fields: [designerId], references: [id])

  /// reason örnekleri:
  /// - AUTO_ASSIGN
  /// - MANUAL
  /// - FALLBACK
  /// - REBALANCE
  /// - SYSTEM_MIGRATION
  reason   String
  notes    String?
  metadata Json?

  createdAt DateTime @default(now())

  @@index([ticketId, createdAt])
  @@index([designerId, createdAt])
  @@index([reason, createdAt])
}
